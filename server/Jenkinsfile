pipeline {
    agent any

    tools {
        nodejs 'node16'
        jdk 'jdk17'
    }

    environment {
        SCANNER_HOME = tool 'sonar-scanner'
        SONAR_ENV    = 'sonar-server'

        IMAGE_NAME   = 'ashwinsai22/kr-market-server'
        DOCKER_CREDS = 'docker'

        ENFORCE_SONAR_QG = 'false'
        ENFORCE_OWASP    = 'false'
        ENFORCE_TRIVY_FS = 'false'
    }

    stages {

        stage('Clean Workspace') {
            steps { cleanWs() }
        }

        stage('Checkout') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/ashwinsai22/ecommerce.git'
            }
        }

        /* ===================== SONAR ===================== */

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SONAR_ENV}") {
                    sh '''
                      cd server
                      $SCANNER_HOME/bin/sonar-scanner \
                        -Dsonar.projectKey=kr-market-server \
                        -Dsonar.projectName=kr-market-server \
                        -Dsonar.sources=.
                    '''
                }
            }
        }

        stage('Quality Gate') {
            steps {
                script {
                    def qg = waitForQualityGate abortPipeline: false
                    echo "Quality Gate: ${qg.status}"

                    if (qg.status != 'OK' && env.ENFORCE_SONAR_QG == 'true') {
                        unstable("Sonar QG failed")
                    }
                }
            }
        }

        /* ===================== BUILD ===================== */

        stage('Install Dependencies') {
            steps {
                sh '''
                  cd server
                  npm install --omit=dev
                '''
            }
        }

        /* ===================== OWASP ===================== */

        stage('OWASP Dependency Check') {
            steps {
                withCredentials([
                    string(credentialsId: 'nvd-api-key', variable: 'NVD_API_KEY')
                ]) {
                    script {
                        def status = sh(
                            script: '''
                              cd server
                              ${tool 'DP-Check'}/bin/dependency-check.sh \
                                --scan ./ \
                                --nvdApiKey "$NVD_API_KEY" \
                                --format XML \
                                --out .
                            ''',
                            returnStatus: true
                        )

                        if (status != 0 && env.ENFORCE_OWASP == 'true') {
                            unstable('OWASP issues found')
                        }
                    }
                }
            }
        }

        /* ===================== TRIVY FS ===================== */

        stage('Trivy FS Scan') {
            steps {
                script {
                    def status = sh(
                        script: 'trivy fs server/',
                        returnStatus: true
                    )

                    if (status != 0 && env.ENFORCE_TRIVY_FS == 'true') {
                        unstable('Trivy FS vulnerabilities')
                    }
                }
            }
        }

        /* ===================== DOCKER ===================== */

        stage('Docker Build & Push') {
            steps {
                withDockerRegistry(
                    credentialsId: DOCKER_CREDS,
                    url: 'https://index.docker.io/v1/'
                ) {
                    sh '''
                      docker build -t $IMAGE_NAME:latest -f Dockerfile.server .
                      docker push $IMAGE_NAME:latest
                    '''
                }
            }
        }

        stage('Trivy Image Scan') {
            steps {
                sh 'trivy image $IMAGE_NAME:latest'
            }
        }
    }

    post {
        always {
            emailext(
                subject: "Server CI: ${currentBuild.currentResult}",
                body: "Job: ${JOB_NAME}\nBuild: ${BUILD_NUMBER}\nStatus: ${currentBuild.currentResult}",
                to: 'ponugumatiashwinsai@gmail.com'
            )
        }
    }
}